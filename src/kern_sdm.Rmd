---
title: "Kern Natives SDM"
author: "Nick McManus"
date: "2023-08-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)    ## always
library(here)         ## reading/writing data
library(terra)        ## Better/faster GIS
library(raster)       ## GIS format required by Dismo
library(dismo)        ## Maxent pkg
library(rJava)        ## Needed for dismo
library(lubridate)    ## Dates and progress bar
```


## Overview

This script extracts environmental data for each species occurrence (based on location and time). This data is then used to perform a species distribution model using Maxent with `dismo`.

*   Species occurrence data was pulled from GBIF (and maybe CalFlora?) and filtered to return reasonably accurate presence-only data in California. The script for this is in "src" directory.

*   Environmental data comes from the Basin Characterization Model version 8.0 (Flint et al., 2021) hosted by USGS. 



## Convert ASC to TIF

Publicly available BCMv8 files are in .asc format. ASCII files have associated coordinates but usually do not have an explicitly defined CRS when read in as a raster. Additionally, .tif have smaller file sizes than .asc, so conversion saves on data storage. Use this code to convert an entire file of .asc files to .tif files with appropriate CRS. BCM data uses NAD83 CA Albers (EPSG:3310), so this is the default for the function.
```{r}
## Read in fxn
source(here('R/asc_to_tif.R'))

## Assign file path (selects all .asc files in directory)
filepath = here('data/bcmv8/2021_2022/')

## Run fxn
asc_to_tif(filepath)
```




## Extract environmental data

Using BCMv8 rasters, we'll extract information for each species occurrence within the given time frame. BCMv8 files are usually zipped by decade. The output will be one CSV with environmental data for each point. 

```{r}
## Read in fxn
source(here('R/env_extract.R'))
```

### Occurrence extraction:
```{r}
## Read in species occurrence df
sppOcc <- read_csv(here('data/species_occurrence_GBIF/a_polycarpa_thinned.csv')) %>% 
  janitor::clean_names() %>% 
  dplyr::select(gbifid, decimallatitude, decimallongitude, month, year)


### 2000-2009 Extraction ----------------------------------------
## select directory of env rasters
path <- here('data/bcmv8/2000_2009/')

## use fxn to extract env data at location of occurrences
occExtract_2000_2009 <- env_extract(2000, 2009, path, sppOcc)


### 2010-2020 Extraction ----------------------------------------
path <- here('data/bcmv8/2010_2020/')

occExtract_2010_2020 <- env_extract(2010, 2020, path, sppOcc)


### 2021-2022 Extraction ----------------------------------------
path <- here('data/bcmv8/2021_2022/')

occExtract_2021_2022 <- env_extract(2021, 2022, path, sppOcc)


### Merge and export --------------------------------------------
occExtract_2000_2022 <- rbind(occExtract_2000_2009, occExtract_2010_2020, occExtract_2021_2022)
write_csv(occExtract_2000_2022, here('data/swd/occExtract_2000_2022.csv'))
```


### Background extraction:
```{r}
## Read in background df
backOcc <- read_csv(here('data/species_occurrence_GBIF/background_points.csv')) %>% 
  janitor::clean_names()


### 2000-2009 Extraction ----------------------------------------
path <- here('data/bcmv8/2000_2009/')

backExtract_2000_2009 <- env_extract(2000, 2009, path, backOcc, lon = 'x', lat = 'y')


### 2010-2020 Extraction ----------------------------------------
path <- here('data/bcmv8/2010_2020/')

backExtract_2010_2020 <- env_extract(2010, 2020, path, backOcc, lon = 'x', lat = 'y')


### 2021-2022 Extraction ----------------------------------------
path <- here('data/bcmv8/2021_2022/')

backExtract_2021_2022 <- env_extract(2021, 2022, path, backOcc, lon = 'x', lat = 'y')


### Merge and export --------------------------------------------
backExtract_2000_2022 <- rbind(backExtract_2000_2009, backExtract_2010_2020, backExtract_2021_2022)
write_csv(backExtract_2000_2022, here('data/swd/backExtract_2000_2022.csv'))
```




## Maxent Models

Construct model using Samples with Data (SWD) method.


### Input data

Read in species occurrence and background data, then wrangle to put in proper format. The model will be run using two temperature predictors: mean temperature [(tmn + tmx)/2] and difference of temperature [tmx-tmn]. After these values are derived, both occurrence and background points will isolated by month and merged into one data frame per month .
```{r}
## Occurrence data ----------------------------------------------------------
swdOcc <- read_csv(here('data/swd/occExtract_2000_2022.csv')) %>% 
  ## Add tmean, tdiff, and presence values
  mutate(tmean = round((tmx+tmn)/2, 2),
         tdiff = round(tmx-tmn, 2),
         presence = 1) %>% 
  ## remove select variables
  dplyr::select(!c(gbifid, tmx, tmn)) %>%  
  ## rename lon/lat cols
  rename(x = decimallongitude,
         y = decimallatitude)

## rearrange x and y to match background df
swdOcc <- swdOcc[, c(2, 1, 3:8)]


## Background Data ----------------------------------------------------------
swdBack <- read_csv(here('data/swd/backExtract_2000_2022.csv')) %>% 
  mutate(tmean = round((tmx+tmn)/2, 2),
         tdiff = round(tmx-tmn, 2),
         presence = 0) %>% 
  dplyr::select(!c(tmx, tmn))


## Bind into one df and
## remove any rows in NAs
swd <- rbind(swdOcc, swdBack)
swd <- swd[complete.cases(swd), ]

write_csv(swd, here('data/swd/swd_2000_2022.csv'))
```

### Model arguments
```{r}
## Select env variables (predictors) for model
x <- read_csv(here('data/swd/swd_2000_2022.csv')) %>% 
  dplyr::select(aet, tmean, tdiff)

## Arguments/options to pass to Maxent()
args <- c('jackknife=TRUE', 
          'autofeature=TRUE', 
          'responsecurves=TRUE', 
          'linear=TRUE',
          'quadratic=TRUE',
          'threshold=TRUE',
          'hinge=FALSE',
          'replicates=5', 'replicatetype=crossvalidate')

## Path to save results
path <- here('data/maxent_outputs/')

## Now run this part to finish up the data work:
p <- swd %>% 
  dplyr::select(presence)
```

### Model fitting
```{r}
testModel <- maxent(x, p, path=path, args=args, removeDuplicates = TRUE)
```


### Final model
```{r}
#Set Arguments/Options to Pass to Maxent
args <- c('jackknife=TRUE', 
          'autofeature=TRUE', 
          'responsecurves=TRUE', 
          'linear=TRUE',
          'quadratic=TRUE',
          'threshold=TRUE',
          'hinge=FALSE', 
          'maximumiterations=100000', 
          'writeplotdata=TRUE')


#Final Model Creation
testFinal <- maxent(x, p, path=path, args=args)

save(testFinal, file = here("data/maxent_outputs/testFinal.rData"))
```



## Predictions

```{r}
## function to avg all env rasters
## TESTING 
startYear = 2000
endYear = 2022

# names <- data.frame(variable = rep(c('aet', 'tmin', 'tmx'), each = 12),
#                        month = c('jan', 'feb', 'mar', 'apr', 'may', 'jun',
#                                  'jul', 'aug', 'sep', 'oct', 'nov', 'dec'))

names <- data.frame(variable = rep('aet', each = 12),
                       month = c('jan', 'feb', 'mar', 'apr', 'may', 'jun',
                                 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'))

pathIn = here('data/bcmv8/2021_2022//')
pathOut = here('data/bcmv8//')

env_avg <- function(variable, month, pathIn, pathOut) {
  ## Read in all files for that var/mo
  files <- list.files(path = pathIn, 
                      ## only list those with matching yr/mo in name
                      pattern = paste0(variable, ".+", month),
                      full=TRUE)
  
  env_stack <- terra::rast(c(files))
  
  ## Average all rasts in stack
  env_avg <- terra::app(env_stack, fun = 'mean')
  
  ## Save
  writeRaster(env_avg, 
              paste0(pathOut, variable, "_", month, "_avg.tif"), 
              overwrite = TRUE)
  
}

env_avg(variable = names$variable[2],
        month = names$month[2],
        pathIn = names$pathIn[2],
        pathOut = names$pathOut[2])

purrr::pmap(names, env_avg, pathIn, pathOut, .progress = TRUE)
```



Testing out prediction maps using only one year of monthly env data. Will likely need to create a function that averages all of the data by month....
```{r}
## Data pathways
path_env <- here('data/bcmv8/2021_2022//')
path_pred <- here('data/maxent_outputs//')

## Function ------------------------------------------------------------------
pred_month <- function(year, month, model, path_env, path_pred) {
  ## read in rasters (masking/math faster in terra)
  aet <- terra::rast(paste0(path_env, 'aet', year, month, '.tif'))
  tmn <- terra::rast(paste0(path_env, 'tmn', year, month, '.tif')) %>% 
    terra::mask(., aet)
  tmx <- terra::rast(paste0(path_env, 'tmx', year, month, '.tif')) %>% 
    terra::mask(., aet)
  
  ## Find temp mean and difference
  tmean <- (tmx+tmn)/2
  tdiff <- tmx-tmn
  
  ## Convert to rasterLayers, stack, and name layers
  aet <- raster(aet)
  tmean <- raster(tmean)
  tdiff <- raster(tdiff)
  
  stack <- raster::stack(aet, tmean, tdiff)
  names(stack) <- c('aet','tmean','tdiff')
  
  ## Predict spp presence with model, then save raster
  pred <- dismo::predict(model, stack)
  writeRaster(pred, paste0(path_pred, month, '.tif'), overwrite=TRUE)
}

## Get predictions for each month ---------------------------------------------
pred_oct <- pred_month('2020', 'oct', model = testFinal, path_env, path_pred)
pred_nov <- pred_month('2020', 'nov', model = testFinal, path_env, path_pred)
pred_dec <- pred_month('2020', 'dec', model = testFinal, path_env, path_pred)
pred_jan <- pred_month('2021', 'jan', model = testFinal, path_env, path_pred)
pred_feb <- pred_month('2021', 'feb', model = testFinal, path_env, path_pred)
pred_mar <- pred_month('2021', 'mar', model = testFinal, path_env, path_pred)
pred_apr <- pred_month('2021', 'apr', model = testFinal, path_env, path_pred)
pred_may <- pred_month('2021', 'may', model = testFinal, path_env, path_pred)
pred_jun <- pred_month('2021', 'jun', model = testFinal, path_env, path_pred)
pred_jul <- pred_month('2021', 'jul', model = testFinal, path_env, path_pred)
pred_aug <- pred_month('2021', 'aug', model = testFinal, path_env, path_pred)
pred_sep <- pred_month('2021', 'sep', model = testFinal, path_env, path_pred)



```



## Response Curves

```{r}

```


























